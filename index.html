<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AquaNemo AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<link rel="stylesheet" href="/index.css">
</head>
  <body class="bg-gray-900 text-gray-100">
    <div id="root"></div>
    <script type="text/babel" data-presets="react">
// --- MOCK DATA --- //
const managerKPIs = [
  { title: "總存活率", value: "98.5%", change: 0.2, positive: true },
  { title: "平均FCR", value: "1.2", change: -0.1, positive: true },
  { title: "預估月利潤", value: "+5.2%", change: 1.5, positive: true },
  { title: "今日總能耗", value: "-3%", change: -1.2, positive: true },
];

const alerts = [
  { 
    type: 'critical', 
    title: '[緊急] 3號槽AI偵測到疑似白點病', 
    content: '2隻魚隻出現異常行為。信賴度92%。', 
    actions: ['查看詳情', '一鍵通報技術員'],
    tankId: 3
  },
  { 
    type: 'warning', 
    title: '[預測] 5號槽溶氧量趨勢下降', 
    content: '預計12小時後可能低於安全閾值。', 
    actions: ['啟動智能增氧排程'],
    tankId: 5
  },
  { 
    type: 'info', 
    title: '[市場] 畢卡索品系國際市場價格上漲8%', 
    content: '建議增加出貨準備。', 
    actions: ['查看市場洞察'],
    tankId: null
  },
];

const tanks = [
    { id: 1, status: 'ok', name: 'A級畢卡索 - 育苗前期', species: '畢卡索' }, 
    { id: 2, status: 'ok', name: 'B級黑瑪瑙 - 中期', species: '黑瑪瑙' }, 
    { id: 3, status: 'critical', name: 'A級畢卡索 - 育苗中期', species: '畢卡索' },
    { id: 4, status: 'ok', name: 'C級雪花 - 後期', species: '雪花' }, 
    { id: 5, status: 'warning', name: 'S級畢卡索 - 親代', species: '畢卡索' }, 
    { id: 6, status: 'ok', name: 'B級黑瑪瑙 - 前期', species: '黑瑪瑙' },
    { id: 7, status: 'ok', name: 'A級雪花 - 中期', species: '雪花' }, 
    { id: 8, status: 'ok', name: '種魚隔離槽', species: '混合' },
];

const financialSummary = {
    revenue: 125000,
    costs: 85000,
    profit: 40000,
};

const costBreakdown = [
    { name: '飼料 (Feed)', value: 45000, color: 'bg-cyan-500' },
    { name: '電力 (Energy)', value: 20000, color: 'bg-violet-500' },
    { name: '人力 (Labor)', value: 15000, color: 'bg-yellow-500' },
    { name: '其他 (Other)', value: 5000, color: 'bg-blue-500' },
];

const monthlyPerformance = [
    { month: '一月', revenue: 40000, cost: 28000 },
    { month: '二月', revenue: 45000, cost: 30000 },
    { month: '三月', revenue: 52000, cost: 35000 },
    { month: '四月', revenue: 48000, cost: 33000 },
];

const batchProfitability = [
    { id: 'A-2024-01', species: '畢卡索', revenue: 50000, cost: 32000, profit: 18000 },
    { id: 'B-2024-01', species: '黑瑪瑙', revenue: 45000, cost: 31000, profit: 14000 },
    { id: 'A-2023-12', species: '畢卡索', revenue: 30000, cost: 22000, profit: 8000 },
    { id: 'C-2024-01', species: '雪花', revenue: 62000, cost: 40000, profit: 22000 },
];

const breedingAssets = [
    { id: '#X10', species: '畢卡索', grade: 'S+', parentId: null, traits: { '白紋連接性': 5, '體型飽滿度': 4 }, healthHistory: '無爛鰭病史', imageUrl: 'https://images.unsplash.com/photo-1535591273668-578e31182c4f?q=80&w=400' },
    { id: '#Y25', species: '畢卡索', grade: 'A', parentId: '#X10', traits: { '白紋連接性': 4, '體型飽滿度': 5 }, healthHistory: '良好', imageUrl: 'https://images.unsplash.com/photo-1593994399702-6c3a1f33a8a0?q=80&w=400' },
    { id: '#Z03', species: '黑瑪瑙', grade: 'S', parentId: null, traits: { '黑體純度': 5, '體型飽滿度': 5 }, healthHistory: '良好', imageUrl: 'https://images.unsplash.com/photo-1544551763-77852e7f7b9b?q=80&w=400' },
    { id: '#A15', species: '雪花', grade: 'A+', parentId: null, traits: { '斑點分布': 4, '體型飽滿度': 4 }, healthHistory: '良好', imageUrl: 'https://images.unsplash.com/photo-1608105315217-1a0525e24a8f?q=80&w=400' },
    { id: '#B30', species: '畢卡索', grade: 'A', parentId: '#X10', traits: { '白紋連接性': 3, '體型飽滿度': 4 }, healthHistory: '無爛鰭病史', imageUrl: 'https://images.unsplash.com/photo-1522069169874-c58ec4b76be5?q=80&w=400' },
    { id: '#C42', species: '黑瑪瑙', grade: 'A', parentId: '#Z03', traits: { '黑體純度': 4, '體型飽滿度': 5 }, healthHistory: '良好', imageUrl: 'https://images.unsplash.com/photo-1560947997-5a4a2f8b5037?q=80&w=400' },
];

// Data for Decision Support
const feedOptions = [
    { id: 'current', name: '目前飼料 (B牌)', costPerKg: 1.8, fcrModifier: 0 },
    { id: 'A', name: 'A牌高效飼料', costPerKg: 2.2, fcrModifier: -0.15 },
    { id: 'C', name: 'C牌經濟飼料', costPerKg: 1.4, fcrModifier: 0.1 },
];

const batchProfitabilityWithFCR = batchProfitability.map((b, i) => ({
    ...b,
    fcr: 1.2 + i * 0.05,
    totalFeedKg: (b.cost * 0.6) / 1.8 
}));

const priceTrends = {
    '畢卡索': [ { week: -3, price: 25 }, { week: -2, price: 26 }, { week: -1, price: 28 }, { week: 0, price: 27 }, { week: 1, price: 29, predicted: true }, { week: 2, price: 30, predicted: true }, { week: 3, price: 31, predicted: true }, { week: 4, price: 30, predicted: true } ],
    '黑瑪瑙': [ { week: -3, price: 30 }, { week: -2, price: 29 }, { week: -1, price: 31 }, { week: 0, price: 32 }, { week: 1, price: 33, predicted: true }, { week: 2, price: 32, predicted: true }, { week: 3, price: 34, predicted: true }, { week: 4, price: 35, predicted: true } ],
};

const marketHotness = [
    { name: '雪花白紋', score: 95, trend: 'up' },
    { name: '閃電紋', score: 88, trend: 'up' },
    { name: '全黑瑪瑙', score: 82, trend: 'stable' },
    { name: '經典畢卡索', score: 75, trend: 'down' },
];

const sustainabilityMetrics = {
    carbonFootprint: { value: 1.25, unit: 'tCO2e/ton', change: -0.05, positive: false },
    waterUsage: { value: 15.3, unit: 'm³/ton', change: -0.2, positive: false },
};

// Data for Farm Setup
const initialFarmLayout = tanks.map((tank, index) => ({
    ...tank,
    gridPosition: { x: index % 4, y: Math.floor(index / 4) },
    devices: [],
}));

const initialIotDevices = [
    { id: 'TEMP-0A3F5C', type: 'temp-sensor', name: '溫度計 #1' },
    { id: 'DO-9B1D8E', type: 'do-sensor', name: '溶氧感測器 #1' },
    { id: 'PH-4C6A2B', type: 'ph-sensor', name: '酸鹼度計 #1' },
    { id: 'CAM-F7E9C1', type: 'camera', name: '水下攝影機 #A' },
    { id: 'TEMP-1B4G6D', type: 'temp-sensor', name: '溫度計 #2' },
    { id: 'DO-8A2E9F', type: 'do-sensor', name: '溶氧感測器 #2' },
];

// Data for User Management
const users = [
  { id: 1, name: '陳經理', email: 'manager.chen@aquanemo.ai', role: '管理者', lastLogin: '2024-05-21 08:30', status: 'active' },
  { id: 2, name: '小李', email: 'li.tech@aquanemo.ai', role: '現場技術員', lastLogin: '2024-05-21 07:55', status: 'active' },
  { id: 3, name: '王博士', email: 'wang.breeder@aquanemo.ai', role: '育種專家', lastLogin: '2024-05-20 15:10', status: 'active' },
  { id: 4, name: '訪客稽核員', email: 'audit@external.com', role: '訪客/稽核員', lastLogin: '2024-05-19 11:00', status: 'disabled' },
];

const initialRolesConfig = {
  '管理者': {
    '查看儀表板': true, '控制設備': true, '編輯警報閾值': true, '查看財務報告': true,
    '管理育種資產': true, '生成報告': true, '管理使用者': true, '設定系統': true,
  },
  '現場技術員': {
    '查看儀表板': true, '控制設備': true, '編輯警報閾值': false, '查看財務報告': false,
    '管理育種資產': false, '生成報告': false, '管理使用者': false, '設定系統': false,
  },
  '育種專家': {
    '查看儀表板': true, '控制設備': false, '編輯警報閾值': false, '查看財務報告': false,
    '管理育種資產': true, '生成報告': true, '管理使用者': false, '設定系統': false,
  },
  '訪客/稽核員': {
    '查看儀表板': true, '控制設備': false, '編輯警報閾值': false, '查看財務報告': true,
    '管理育種資產': false, '生成報告': true, '管理使用者': false, '設定系統': false,
  },
};

const initialAutomationRules = [
    { id: 1, name: "低溶氧自動增氧", description: "當任一槽溶氧量低於 5.0 持續 5 分鐘，自動啟動增氧機並通知技術員", enabled: true },
    { id: 2, name: "夜間節能模式", description: "每日 22:00 至 06:00，自動降低水泵流速 20%", enabled: true },
    { id: 3, name: "AI 疾病警報", description: "當 AI 偵測到疑似疾病，自動建立紅色警報並發送通知給管理者與技術員", enabled: false },
];

const iotDeviceStatus = [
    ...initialIotDevices,
    { id: 'PUMP-A01', type: 'pump', name: '主循環水泵 #1' },
    { id: 'PUMP-A02', type: 'pump', name: '主循環水泵 #2' },
    { id: 'AERATOR-01', type: 'aerator', name: '增氧機 (1號槽)' },
].map((device, i) => ({ ...device, status: i % 6 === 0 ? 'offline' : 'online', tankId: (i % 8) + 1 }));


const systemLogs = [
    { timestamp: '2024-05-21 10:05:15', level: 'INFO', message: '使用者 陳經理 登入系統' },
    { timestamp: '2024-05-21 10:05:20', level: 'INFO', message: '規則 #1 觸發: 5號槽溶氧量為 4.8 mg/L' },
    { timestamp: '2024-05-21 10:05:21', level: 'INFO', message: '執行動作: 啟動5號槽增氧機' },
    { timestamp: '2024-05-21 10:05:22', level: 'INFO', message: '執行動作: 發送SMS通知至 現場技術員群組' },
    { timestamp: '2024-05-21 09:45:10', level: 'WARN', message: '設備 TEMP-0A3F5C 回傳數據延遲超過 60 秒' },
    { timestamp: '2024-05-21 09:30:00', level: 'ERROR', message: '無法連接至資料庫備份伺服器 (connection timeout)' },
];

// --- HELPER & GENERIC COMPONENTS --- //
const Icon = ({ name, className, title }) => <i className={`fa-solid ${name} ${className}`} title={title}></i>;

const Card = ({ children, className }) => (
    <div className={`bg-gray-800 border border-gray-700 rounded-lg p-4 shadow-md ${className}`}>
        {children}
    </div>
);

const ToggleSwitch = ({ enabled, onChange }) => (
  <button
    type="button"
    className={`${
      enabled ? 'bg-cyan-600' : 'bg-gray-600'
    } relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-offset-2 focus:ring-offset-gray-800`}
    role="switch"
    aria-checked={enabled}
    onClick={() => onChange(!enabled)}
  >
    <span
      aria-hidden="true"
      className={`${
        enabled ? 'translate-x-5' : 'translate-x-0'
      } pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out`}
    />
  </button>
);

// --- APP COMPONENTS --- //

const Header = ({ setView }) => {
    return (
        <header className="flex justify-between items-center p-4 bg-gray-900 border-b border-gray-700">
            <div className="flex items-center space-x-3">
                <Icon name="fa-fish-fins" className="text-2xl text-cyan-400" />
                <h1 className="text-xl font-bold text-white">AquaNemo AI</h1>
            </div>
            <div className="flex items-center space-x-6">
                <span className="text-gray-300">歡迎, 陳經理</span>
                <button onClick={() => setView('settings')} className="text-gray-400 hover:text-white transition-colors">
                    <Icon name="fa-gear" className="text-lg" />
                </button>
            </div>
        </header>
    );
};

const KpiCard = ({ kpi }) => {
    const isPositive = (kpi.positive && kpi.change > 0) || (!kpi.positive && kpi.change < 0);
    const color = kpi.change ? (isPositive ? 'text-green-400' : 'text-red-400') : 'text-gray-400';
    const icon = kpi.change ? (isPositive ? 'fa-arrow-up' : 'fa-arrow-down') : '';

    return (
        <div className="bg-gray-800 p-4 rounded-lg flex-1">
            <p className="text-sm text-gray-400">{kpi.title}</p>
            <p className="text-3xl font-bold text-white my-1">{kpi.value}</p>
            {kpi.change !== undefined && (
                <div className={`flex items-center text-sm ${color}`}>
                    <Icon name={icon} className="mr-1" />
                    <span>{Math.abs(kpi.change)}%</span>
                </div>
            )}
        </div>
    );
};


const AlertCard = ({ alert, onSelectTank }) => {
    const colors = {
        critical: 'border-red-500',
        warning: 'border-yellow-500',
        info: 'border-blue-500',
    };
    const iconColors = {
        critical: 'text-red-500',
        warning: 'text-yellow-500',
        info: 'text-blue-500',
    }
    const icons = {
        critical: 'fa-triangle-exclamation',
        warning: 'fa-shield-halved',
        info: 'fa-circle-info',
    }
    const buttonStyles = {
        critical: 'bg-red-600 hover:bg-red-700',
        warning: 'bg-yellow-600 hover:bg-yellow-700',
        info: 'bg-blue-600 hover:bg-blue-700',
    }
    
    const handleActionClick = (action) => {
        if (action.includes('查看詳情') && alert.tankId) {
            onSelectTank(alert.tankId);
        }
    }

    return (
        <div className={`bg-gray-800 rounded-lg p-4 border-l-4 ${colors[alert.type]}`}>
            <div className="flex items-start space-x-3">
                <Icon name={icons[alert.type]} className={`mt-1 text-xl ${iconColors[alert.type]}`} />
                <div>
                    <h3 className="font-bold text-white">{alert.title}</h3>
                    <p className="text-sm text-gray-300 mt-1">{alert.content}</p>
                    <div className="mt-3 flex flex-wrap gap-2">
                        {alert.actions.map(action => (
                            <button key={action} onClick={() => handleActionClick(action)} className={`px-3 py-1 text-xs font-semibold text-white rounded-md ${buttonStyles[alert.type]} transition-colors`}>
                                {action}
                            </button>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- VIEWS --- //

const Dashboard = ({ onSelectTank, setView }) => {
    return (
        <div className="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Left Column: Alerts and Quick Access */}
            <div className="lg:col-span-1 flex flex-col gap-6">
                <Card>
                    <h2 className="text-lg font-bold mb-4 text-white">智慧警報牆 (Smart Alert Wall)</h2>
                    <div className="space-y-4">
                        {alerts.map(alert => <AlertCard key={alert.title} alert={alert} onSelectTank={onSelectTank} />)}
                    </div>
                </Card>
                <Card>
                    <h2 className="text-lg font-bold mb-4 text-white">快捷功能面板 (Quick Access Panel)</h2>
                     <ul className="space-y-3">
                        <li><a href="#" onClick={(e) => { e.preventDefault(); setView('financial-reports'); }} className="flex items-center space-x-3 text-cyan-400 hover:text-cyan-300"><Icon name="fa-chart-pie" /><span>查看財務報表</span></a></li>
                        <li><a href="#" onClick={(e) => { e.preventDefault(); setView('breeding-hub'); }} className="flex items-center space-x-3 text-cyan-400 hover:text-cyan-300"><Icon name="fa-dna" /><span>進入育種資產庫</span></a></li>
                        <li><a href="#" onClick={(e) => { e.preventDefault(); setView('decision-support'); }} className="flex items-center space-x-3 text-cyan-400 hover:text-cyan-300"><Icon name="fa-lightbulb" /><span>決策支援</span></a></li>
                        <li><a href="#" onClick={(e) => { e.preventDefault(); setView('sustainability-report'); }} className="flex items-center space-x-3 text-cyan-400 hover:text-cyan-300"><Icon name="fa-leaf" /><span>生成永續報告</span></a></li>
                    </ul>
                </Card>
            </div>

            {/* Right Column: KPIs and Farm Map */}
            <div className="lg:col-span-2 flex flex-col gap-6">
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    {managerKPIs.map(kpi => <KpiCard key={kpi.title} kpi={kpi} />)}
                </div>
                <Card className="flex-grow">
                     <h2 className="text-lg font-bold mb-4 text-white">中央全場數位地圖 (Interactive Farm Map)</h2>
                     <div className="grid grid-cols-4 gap-4 bg-gray-900/50 p-4 rounded-md aspect-video">
                        {tanks.map(tank => {
                             const statusClasses = {
                                ok: 'bg-green-500/20 border-green-500 hover:bg-green-500/40',
                                warning: 'bg-yellow-500/20 border-yellow-500 hover:bg-yellow-500/40 animate-pulse',
                                critical: 'bg-red-500/20 border-red-500 hover:bg-red-500/40 animate-pulse',
                            };
                            return (
                                <div key={tank.id} 
                                     onClick={() => onSelectTank(tank.id)}
                                     className={`flex items-center justify-center border-2 rounded-md cursor-pointer transition-colors ${statusClasses[tank.status]}`}>
                                    <span className="font-bold text-xl text-white">槽 {tank.id}</span>
                                </div>
                            );
                        })}
                     </div>
                </Card>
            </div>
        </div>
    );
};

const TankDetails = ({ tankId, onBack }) => {
    const tank = tanks.find(t => t.id === tankId);
    if (!tank) return null;

    return (
        <div className="p-6">
            <button onClick={onBack} className="mb-4 flex items-center space-x-2 text-cyan-400 hover:text-cyan-300">
                <Icon name="fa-arrow-left" />
                <span>返回儀表板</span>
            </button>
            <Card>
                <h2 className="text-xl font-bold text-white mb-4">{tank.id}號槽 - {tank.name}</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 className="font-bold mb-2">即時水質數據</h3>
                        <div className="bg-gray-900/50 p-4 rounded-md space-y-4">
                            <div>
                                <p className="text-sm text-gray-400">溶氧量 (mg/L)</p>
                                <div className="h-20 bg-gray-700 rounded-md p-2">
                                     <svg width="100%" height="100%" viewBox="0 0 300 80" preserveAspectRatio="none"><polyline fill="none" stroke="#38bdf8" strokeWidth="2" points="0,40 50,30 100,50 150,45 200,60 250,55 300,70" /></svg>
                                </div>
                            </div>
                             <div>
                                <p className="text-sm text-gray-400">溫度 (°C)</p>
                                <div className="h-20 bg-gray-700 rounded-md p-2">
                                     <svg width="100%" height="100%" viewBox="0 0 300 80" preserveAspectRatio="none"><polyline fill="none" stroke="#a78bfa" strokeWidth="2" points="0,30 50,32 100,28 150,35 200,33 250,36 300,34" /></svg>
                                </div>
                            </div>
                        </div>
                        <div className="mt-4">
                            <h3 className="font-bold mb-2">事件時間軸 (過去48小時)</h3>
                            <input type="range" className="w-full" />
                        </div>
                    </div>
                    <div>
                        <h3 className="font-bold mb-2">即時水下影像串流</h3>
                        <div className="aspect-video bg-gray-900 rounded-md relative flex items-center justify-center">
                            <p className="text-gray-500">Live Feed</p>
                            {tank.status === 'critical' && (
                                <>
                                <div className="absolute top-1/4 left-1/4 w-1/3 h-1/3 border-2 border-red-500 rounded-md animate-pulse">
                                    <span className="absolute -top-6 left-0 text-xs bg-red-500 text-white px-2 py-0.5 rounded-md">異常行為 1</span>
                                </div>
                                <div className="absolute bottom-1/4 right-1/4 w-1/4 h-1/4 border-2 border-red-500 rounded-md animate-pulse">
                                     <span className="absolute -top-6 left-0 text-xs bg-red-500 text-white px-2 py-0.5 rounded-md">異常行為 2</span>
                                </div>
                                <div className="absolute bottom-4 right-4 bg-black/50 p-2 rounded-md text-sm">
                                    <p className="text-red-400 font-bold">AI分析:</p>
                                    <p>疑似白點病, 信賴度92%</p>
                                </div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
                <div className="mt-6 border-t border-gray-700 pt-4">
                    <h3 className="font-bold mb-4">一鍵式操作面板 (Action Panel)</h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button className="bg-cyan-600 hover:bg-cyan-700 p-3 rounded-lg text-white font-semibold transition-colors"><Icon name="fa-wind" className="mr-2"/>手動增氧</button>
                        <button className="bg-cyan-600 hover:bg-cyan-700 p-3 rounded-lg text-white font-semibold transition-colors"><Icon name="fa-water" className="mr-2"/>調整水泵流速</button>
                        <button className="bg-yellow-600 hover:bg-yellow-700 p-3 rounded-lg text-white font-semibold transition-colors"><Icon name="fa-right-to-bracket" className="mr-2"/>隔離警報</button>
                        <button className="bg-indigo-600 hover:bg-indigo-700 p-3 rounded-lg text-white font-semibold transition-colors"><Icon name="fa-pills" className="mr-2"/>用藥紀錄</button>
                    </div>
                </div>
            </Card>
        </div>
    );
};

const PriceChart = ({ data, color, predictedColor }) => {
    const maxPrice = Math.max(...data.map(d => d.price)) + 2;
    const minPrice = Math.min(...data.map(d => d.price)) - 2;
    const pointToCoords = (d, i) => `${i * 40},${80 - ((d.price - minPrice) / (maxPrice - minPrice)) * 80}`;
    
    const historicalData = data.filter(d => !d.predicted);
    const predictionData = data.filter(d => d.predicted);
    if (historicalData.length > 0) {
        predictionData.unshift(historicalData[historicalData.length - 1]);
    }
    
    const historicalPoints = historicalData.map(pointToCoords).join(' ');
    const predictionPoints = predictionData.map((d, i) => pointToCoords(d, historicalData.length -1 + i)).join(' ');

    return (
        <svg width="100%" height="100%" viewBox="0 0 300 80" preserveAspectRatio="none">
            <polyline fill="none" stroke={color} strokeWidth="2" points={historicalPoints} />
            {predictionPoints && <polyline fill="none" stroke={predictedColor} strokeWidth="2" strokeDasharray="4 4" points={predictionPoints} />}
        </svg>
    );
};


const DecisionSupport = ({ onBack }) => {
    const [tab, setTab] = React.useState('efficiency');
    const [selectedBatchId, setSelectedBatchId] = React.useState(batchProfitabilityWithFCR[0].id);
    const [selectedFeedId, setSelectedFeedId] = React.useState(feedOptions[0].id);
    
    const selectedBatch = batchProfitabilityWithFCR.find(b => b.id === selectedBatchId);
    const selectedFeed = feedOptions.find(f => f.id === selectedFeedId);
    
    let simulatedFCR, feedCostChange, profitChange;

    if (selectedBatch && selectedFeed) {
        simulatedFCR = selectedBatch.fcr + selectedFeed.fcrModifier;
        const originalFeedCost = selectedBatch.totalFeedKg * feedOptions[0].costPerKg;
        const newFeedCost = selectedBatch.totalFeedKg * selectedFeed.costPerKg;
        feedCostChange = newFeedCost - originalFeedCost;
        profitChange = -feedCostChange;
    }
    
    const efficiencyContent = (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
                <h3 className="text-lg font-bold text-white mb-4">飼料效益模擬器 (Feed Strategy Simulator)</h3>
                <Card className="bg-gray-900/50">
                    <div className="space-y-4">
                        <div>
                            <label htmlFor="batch-select" className="block text-sm font-medium text-gray-300 mb-1">選擇批次</label>
                            <select id="batch-select" value={selectedBatchId} onChange={e => setSelectedBatchId(e.target.value)} className="w-full bg-gray-700 border-gray-600 rounded-md py-2 px-3 focus:ring-cyan-500 focus:border-cyan-500">
                                {batchProfitabilityWithFCR.map(b => <option key={b.id} value={b.id}>{b.id} ({b.species})</option>)}
                            </select>
                        </div>
                        <div>
                            <label htmlFor="feed-select" className="block text-sm font-medium text-gray-300 mb-1">選擇模擬飼料</label>
                             <select id="feed-select" value={selectedFeedId} onChange={e => setSelectedFeedId(e.target.value)} className="w-full bg-gray-700 border-gray-600 rounded-md py-2 px-3 focus:ring-cyan-500 focus:border-cyan-500">
                                {feedOptions.map(f => <option key={f.id} value={f.id}>{f.name} (${f.costPerKg}/kg)</option>)}
                            </select>
                        </div>
                    </div>
                    <div className="mt-6 border-t border-gray-600 pt-4">
                        <h4 className="font-semibold text-white mb-2">模擬結果</h4>
                        {selectedBatch && selectedFeed && (
                            <div className="grid grid-cols-2 gap-4 text-center">
                                <div className="bg-gray-800 p-3 rounded-lg">
                                    <p className="text-sm text-gray-400">預估FCR</p>
                                    <p className="text-2xl font-bold">{simulatedFCR.toFixed(2)}</p>
                                    <p className={`text-sm font-semibold ${selectedFeed.fcrModifier >= 0 ? 'text-red-400' : 'text-green-400'}`}>
                                        {selectedFeed.fcrModifier !== 0 ? (selectedFeed.fcrModifier > 0 ? `+${selectedFeed.fcrModifier.toFixed(2)}` : selectedFeed.fcrModifier.toFixed(2)) : <>&nbsp;</>}
                                    </p>
                                </div>
                                <div className="bg-gray-800 p-3 rounded-lg">
                                    <p className="text-sm text-gray-400">預估利潤變化</p>
                                    <p className={`text-2xl font-bold ${profitChange >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                        {profitChange >= 0 ? `+$${profitChange.toFixed(0)}` : `-$${Math.abs(profitChange).toFixed(0)}`}
                                    </p>
                                    <p className="text-sm text-gray-400">對比目前飼料</p>
                                </div>
                            </div>
                        )}
                    </div>
                </Card>
            </div>
            <div>
                 <h3 className="text-lg font-bold text-white mb-4">生產批次成本結構</h3>
                 <div className="space-y-3 max-h-96 overflow-y-auto pr-2">
                     {batchProfitabilityWithFCR.map(b => (
                         <Card key={b.id} className="bg-gray-900/50">
                             <div className="flex justify-between items-center">
                                 <div>
                                     <p className="font-bold">{b.id} ({b.species})</p>
                                     <p className="text-xs text-gray-400">利潤: ${b.profit.toLocaleString()}</p>
                                 </div>
                                 <div className="w-1/2">
                                     <div className="flex h-4 rounded-full overflow-hidden bg-gray-700" title={`飼料: 60%, 電力: 20%, 人力: 15%, 其他: 5%`}>
                                         <div className="bg-cyan-500" style={{ width: `60%`}} title="飼料"></div>
                                         <div className="bg-violet-500" style={{ width: `20%`}} title="電力"></div>
                                         <div className="bg-yellow-500" style={{ width: `15%`}} title="人力"></div>
                                         <div className="bg-blue-500" style={{ width: `5%`}} title="其他"></div>
                                     </div>
                                 </div>
                             </div>
                         </Card>
                     ))}
                 </div>
            </div>
        </div>
    );
    
    const marketContent = (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
                <h3 className="text-lg font-bold text-white mb-4">價格趨勢與預測 (未來4週)</h3>
                <Card className="bg-gray-900/50 space-y-4">
                    <div>
                        <h4 className="font-semibold text-cyan-400">畢卡索</h4>
                        <div className="h-32 bg-gray-800 p-2 rounded-md"><PriceChart data={priceTrends['畢卡索']} color="#22d3ee" predictedColor="#a78bfa" /></div>
                    </div>
                    <div>
                        <h4 className="font-semibold text-gray-300">黑瑪瑙</h4>
                        <div className="h-32 bg-gray-800 p-2 rounded-md"><PriceChart data={priceTrends['黑瑪瑙']} color="#f472b6" predictedColor="#a78bfa" /></div>
                    </div>
                </Card>
            </div>
            <div>
                <h3 className="text-lg font-bold text-white mb-4">市場熱度趨勢圖</h3>
                <Card className="bg-gray-900/50">
                    <ul className="space-y-3">
                        {marketHotness.map(item => (
                            <li key={item.name} className="flex items-center justify-between p-2 bg-gray-800 rounded-md">
                                <span className="font-medium">{item.name}</span>
                                <div className="flex items-center space-x-2">
                                    <span className="text-sm text-gray-400">熱度: {item.score}</span>
                                    {item.trend === 'up' && <Icon name="fa-arrow-trend-up" className="text-green-400"/>}
                                    {item.trend === 'stable' && <Icon name="fa-minus" className="text-gray-400"/>}
                                    {item.trend === 'down' && <Icon name="fa-arrow-trend-down" className="text-red-400"/>}
                                </div>
                            </li>
                        ))}
                    </ul>
                </Card>
            </div>
        </div>
    );

    const sustainabilityContent = (
        <div>
            <h3 className="text-lg font-bold text-white mb-4">永續績效指標</h3>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <Card className="text-center">
                     <p className="text-sm text-gray-400">預估碳足跡</p>
                     <p className="text-3xl font-bold my-1">{sustainabilityMetrics.carbonFootprint.value} <span className="text-lg">{sustainabilityMetrics.carbonFootprint.unit}</span></p>
                      <div className={`flex items-center justify-center text-sm ${!sustainabilityMetrics.carbonFootprint.positive ? 'text-green-400' : 'text-red-400'}`}>
                         <Icon name={sustainabilityMetrics.carbonFootprint.change > 0 ? 'fa-arrow-up' : 'fa-arrow-down'} className="mr-1" />
                         <span>{Math.abs(sustainabilityMetrics.carbonFootprint.change)} vs 上一期</span>
                     </div>
                </Card>
                <Card className="text-center">
                     <p className="text-sm text-gray-400">水資源利用率</p>
                     <p className="text-3xl font-bold my-1">{sustainabilityMetrics.waterUsage.value} <span className="text-lg">{sustainabilityMetrics.waterUsage.unit}</span></p>
                     <div className={`flex items-center justify-center text-sm ${!sustainabilityMetrics.waterUsage.positive ? 'text-green-400' : 'text-red-400'}`}>
                         <Icon name={sustainabilityMetrics.waterUsage.change > 0 ? 'fa-arrow-up' : 'fa-arrow-down'} className="mr-1" />
                         <span>{Math.abs(sustainabilityMetrics.waterUsage.change)} vs 上一期</span>
                     </div>
                </Card>
                <Card className="flex flex-col items-center justify-center bg-gray-800 hover:bg-gray-700 transition-colors">
                    <button onClick={() => alert('生成ASC溫室氣體報告...')} className="w-full h-full text-white font-semibold">
                        <Icon name="fa-file-pdf" className="text-3xl mb-2"/>
                        <span className="block">生成永續報告</span>
                    </button>
                </Card>
            </div>
        </div>
    );

    return (
      <div className="p-6">
        <button onClick={onBack} className="mb-4 flex items-center space-x-2 text-cyan-400 hover:text-cyan-300">
          <Icon name="fa-arrow-left" />
          <span>返回儀表板</span>
        </button>
        <Card>
            <h2 className="text-xl font-bold text-white mb-4">決策支援模組</h2>
            <div className="border-b border-gray-700 mb-6">
                <nav className="-mb-px flex space-x-8" aria-label="Tabs">
                    <button onClick={() => setTab('efficiency')} className={`whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm ${tab === 'efficiency' ? 'border-cyan-500 text-cyan-400' : 'border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500'}`}>生產效益</button>
                    <button onClick={() => setTab('market')} className={`whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm ${tab === 'market' ? 'border-cyan-500 text-cyan-400' : 'border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500'}`}>市場洞察</button>
                    <button onClick={() => setTab('sustainability')} className={`whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm ${tab === 'sustainability' ? 'border-cyan-500 text-cyan-400' : 'border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500'}`}>永續績效</button>
                </nav>
            </div>
            {tab === 'efficiency' && efficiencyContent}
            {tab === 'market' && marketContent}
            {tab === 'sustainability' && sustainabilityContent}
        </Card>
      </div>
    );
};

const FarmSetup = () => {
    const [layout, setLayout] = React.useState(initialFarmLayout);
    const [unassignedDevices, setUnassignedDevices] = React.useState(initialIotDevices);
    const [selectedTank, setSelectedTank] = React.useState(null);

    const getDeviceIcon = (type) => {
        switch(type) {
            case 'temp-sensor': return 'fa-temperature-half';
            case 'do-sensor': return 'fa-wind';
            case 'ph-sensor': return 'fa-flask-vial';
            case 'camera': return 'fa-camera';
            default: return 'fa-microchip';
        }
    };

    const handleDragStart = (e, device) => {
        e.dataTransfer.setData("application/json", JSON.stringify(device));
    };

    const handleDrop = (e, targetTankId) => {
        e.preventDefault();
        const deviceData = e.dataTransfer.getData("application/json");
        if (deviceData) {
            const device = JSON.parse(deviceData);
            // Add device to tank
            setLayout(prevLayout => prevLayout.map(tank => 
                tank.id === targetTankId 
                ? { ...tank, devices: [...tank.devices, device] } 
                : tank
            ));
            // Remove from unassigned
            setUnassignedDevices(prev => prev.filter(d => d.id !== device.id));
        }
        e.currentTarget.classList.remove('bg-cyan-500/30');
    };

    const handleDragOver = (e) => {
        e.preventDefault();
        e.currentTarget.classList.add('bg-cyan-500/30');
    };

    const handleDragLeave = (e) => {
         e.currentTarget.classList.remove('bg-cyan-500/30');
    };
    
    const handleTankUpdate = (e) => {
        if (!selectedTank) return;
        const { name, value } = e.target;
        const updatedTank = { ...selectedTank, [name]: value };
        setSelectedTank(updatedTank);
        setLayout(layout.map(t => t.id === updatedTank.id ? updatedTank : t));
    }

    return (
        <div className="flex gap-6 h-[calc(100vh-220px)]">
            {/* Left Panel: Devices */}
            <aside className="w-1/4 flex flex-col gap-4">
                 <Card className="flex-grow flex flex-col">
                    <h3 className="text-lg font-semibold mb-4 text-white">未配對設備</h3>
                    <div className="space-y-3 overflow-y-auto flex-grow">
                        {unassignedDevices.map(device => (
                            <div key={device.id} draggable onDragStart={(e) => handleDragStart(e, device)}
                                className="bg-gray-700 p-3 rounded-md cursor-grab active:cursor-grabbing flex items-center space-x-3">
                                <Icon name={getDeviceIcon(device.type)} className="text-cyan-400 text-lg" />
                                <div>
                                    <p className="font-semibold">{device.name}</p>
                                    <p className="text-xs text-gray-400">{device.id}</p>
                                </div>
                            </div>
                        ))}
                         {unassignedDevices.length === 0 && <p className="text-center text-gray-500 pt-8">所有設備皆已配對</p>}
                    </div>
                </Card>
            </aside>
            {/* Center Panel: Farm Layout */}
            <main className="w-2/4">
                <Card className="h-full">
                    <h3 className="text-lg font-semibold mb-4 text-white">場區編輯器</h3>
                    <div className="grid grid-cols-4 gap-4 bg-gray-900/50 p-4 rounded-md h-[calc(100%-40px)]">
                        {layout.map(tank => (
                            <div key={tank.id} 
                                 onDrop={(e) => handleDrop(e, tank.id)}
                                 onDragOver={handleDragOver}
                                 onDragLeave={handleDragLeave}
                                 onClick={() => setSelectedTank(tank)}
                                 className={`border-2 rounded-md p-3 flex flex-col justify-between cursor-pointer transition-all ${selectedTank?.id === tank.id ? 'border-cyan-500 shadow-lg shadow-cyan-500/20' : 'border-gray-700 hover:border-gray-500'}`}>
                                <div>
                                    <p className="font-bold text-lg">槽 {tank.id}</p>
                                    <p className="text-xs text-gray-400 truncate">{tank.name}</p>
                                </div>
                                <div className="flex flex-wrap gap-2 mt-2">
                                    {tank.devices.map(d => (
                                        <Icon key={d.id} name={getDeviceIcon(d.type)} title={d.name} className="text-lg text-gray-300"/>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </Card>
            </main>
            {/* Right Panel: Properties */}
            <aside className="w-1/4">
                 <Card className="h-full">
                    <h3 className="text-lg font-semibold mb-4 text-white">屬性編輯</h3>
                    {selectedTank ? (
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-1">槽區編號</label>
                                <input type="text" value={`槽 ${selectedTank.id}`} disabled className="w-full bg-gray-700/50 border-gray-600 rounded-md py-2 px-3 opacity-70 cursor-not-allowed"/>
                            </div>
                             <div>
                                <label htmlFor="tank-name" className="block text-sm font-medium text-gray-300 mb-1">槽區名稱</label>
                                <input id="tank-name" name="name" type="text" value={selectedTank.name} onChange={handleTankUpdate} className="w-full bg-gray-700 border-gray-600 rounded-md py-2 px-3 focus:ring-cyan-500 focus:border-cyan-500"/>
                            </div>
                             <div>
                                <label htmlFor="tank-species" className="block text-sm font-medium text-gray-300 mb-1">養殖物種</label>
                                <input id="tank-species" name="species" type="text" value={selectedTank.species} onChange={handleTankUpdate} className="w-full bg-gray-700 border-gray-600 rounded-md py-2 px-3 focus:ring-cyan-500 focus:border-cyan-500"/>
                            </div>
                             <div className="border-t border-gray-700 pt-4">
                                <h4 className="font-semibold text-gray-200 mb-2">已配對設備</h4>
                                <ul className="space-y-2">
                                    {selectedTank.devices.map(d => (
                                        <li key={d.id} className="flex items-center space-x-2 text-sm">
                                            <Icon name={getDeviceIcon(d.type)} className="text-cyan-400" />
                                            <span>{d.name}</span>
                                        </li>
                                    ))}
                                    {selectedTank.devices.length === 0 && <p className="text-sm text-gray-500">無</p>}
                                </ul>
                            </div>
                        </div>
                    ) : (
                        <div className="flex items-center justify-center h-full">
                            <p className="text-gray-500">請點擊一個槽區以編輯</p>
                        </div>
                    )}
                 </Card>
            </aside>
        </div>
    );
};

const UserManagement = () => {
    const [userList, setUserList] = React.useState(users);
    const [roles, setRoles] = React.useState(initialRolesConfig);
    const [activeTab, setActiveTab] = React.useState('users');
    const [selectedRole, setSelectedRole] = React.useState('管理者');
    const [isAddingUser, setIsAddingUser] = React.useState(false);

    const handlePermissionChange = (role, permission, value) => {
         setRoles(prev => ({
             ...prev,
             [role]: { ...prev[role], [permission]: value }
         }));
    };
    
    const handleAddUser = (e) => {
        e.preventDefault();
        const formData = new FormData(e.currentTarget);
        const newUser = {
            id: userList.length + 1,
            name: formData.get('name'),
            email: formData.get('email'),
            role: formData.get('role'),
            lastLogin: '尚未登入',
            status: 'active'
        };
        setUserList([...userList, newUser]);
        setIsAddingUser(false);
    };

    const tabButtonClasses = (tabName) => 
        `whitespace-nowrap pb-3 px-1 border-b-2 font-medium text-sm transition-colors ${activeTab === tabName ? 'border-cyan-500 text-cyan-400' : 'border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500'}`;

    return (
        <Card>
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-semibold text-white">使用者與權限管理</h3>
                {activeTab === 'users' && (
                    <button onClick={() => setIsAddingUser(!isAddingUser)} className="bg-cyan-600 hover:bg-cyan-700 px-3 py-1.5 rounded-md text-sm font-semibold flex items-center">
                        <Icon name={isAddingUser ? "fa-times" : "fa-user-plus"} className="mr-2"/>{isAddingUser ? "取消" : "新增使用者"}
                    </button>
                )}
            </div>
            
            <div className="border-b border-gray-700 mb-4">
                <nav className="-mb-px flex space-x-8">
                    <button onClick={() => setActiveTab('users')} className={tabButtonClasses('users')}>使用者列表</button>
                    <button onClick={() => setActiveTab('roles')} className={tabButtonClasses('roles')}>角色權限編輯器</button>
                </nav>
            </div>

            {isAddingUser && activeTab === 'users' && (
                 <form onSubmit={handleAddUser} className="bg-gray-700/50 p-4 rounded-lg mb-4 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div className="md:col-span-1">
                        <label htmlFor="name" className="block text-xs font-medium text-gray-300 mb-1">姓名</label>
                        <input type="text" name="name" id="name" required className="w-full bg-gray-800 border-gray-600 rounded-md py-2 px-3 text-sm focus:ring-cyan-500 focus:border-cyan-500"/>
                    </div>
                    <div className="md:col-span-1">
                        <label htmlFor="email" className="block text-xs font-medium text-gray-300 mb-1">帳號 (Email)</label>
                        <input type="email" name="email" id="email" required className="w-full bg-gray-800 border-gray-600 rounded-md py-2 px-3 text-sm focus:ring-cyan-500 focus:border-cyan-500"/>
                    </div>
                    <div>
                        <label htmlFor="role" className="block text-xs font-medium text-gray-300 mb-1">角色</label>
                        <select name="role" id="role" defaultValue="現場技術員" className="w-full bg-gray-800 border-gray-600 rounded-md py-2 px-3 text-sm focus:ring-cyan-500 focus:border-cyan-500">
                             {Object.keys(roles).map(r => <option key={r} value={r}>{r}</option>)}
                        </select>
                    </div>
                    <button type="submit" className="bg-green-600 hover:bg-green-700 px-3 py-2 rounded-md text-sm font-semibold">儲存使用者</button>
                </form>
            )}

            {activeTab === 'users' && (
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left">
                        <thead className="text-xs text-gray-400 uppercase bg-gray-700/50">
                            <tr>
                                <th scope="col" className="px-6 py-3">姓名</th>
                                <th scope="col" className="px-6 py-3">帳號 (Email)</th>
                                <th scope="col" className="px-6 py-3">角色</th>
                                <th scope="col" className="px-6 py-3">最後登入</th>
                                <th scope="col" className="px-6 py-3">狀態</th>
                                <th scope="col" className="px-6 py-3">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {userList.map(user => (
                                <tr key={user.id} className="border-b border-gray-700 hover:bg-gray-700/50">
                                    <td className="px-6 py-4 font-medium whitespace-nowrap">{user.name}</td>
                                    <td className="px-6 py-4">{user.email}</td>
                                    <td className="px-6 py-4">{user.role}</td>
                                    <td className="px-6 py-4">{user.lastLogin}</td>
                                    <td className="px-6 py-4">
                                        <span className={`px-2 py-1 text-xs font-semibold rounded-full ${user.status === 'active' ? 'bg-green-500/30 text-green-300' : 'bg-red-500/30 text-red-300'}`}>
                                            {user.status === 'active' ? '啟用中' : '已停用'}
                                        </span>
                                    </td>
                                    <td className="px-6 py-4 space-x-3">
                                        <button className="text-cyan-400 hover:text-cyan-300"><Icon name="fa-pen-to-square"/> 編輯</button>
                                        <button className="text-red-400 hover:text-red-300"><Icon name="fa-trash-can"/> 停用</button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
            
            {activeTab === 'roles' && (
                <div className="flex gap-6">
                    <aside className="w-1/4">
                        <h4 className="font-semibold text-white mb-2">選擇角色</h4>
                        <div className="space-y-1">
                            {Object.keys(roles).map(role => (
                                <button key={role} onClick={() => setSelectedRole(role)}
                                    className={`w-full text-left p-2 rounded-md text-sm ${selectedRole === role ? 'bg-cyan-500/20 text-cyan-400' : 'hover:bg-gray-700'}`}>
                                    {role}
                                </button>
                            ))}
                        </div>
                    </aside>
                    <main className="w-3/4 bg-gray-900/50 p-4 rounded-lg">
                        <h4 className="font-semibold text-white mb-4">編輯 <span className="text-cyan-400">{selectedRole}</span> 的權限</h4>
                        <div className="grid grid-cols-2 gap-4">
                            {Object.entries(roles[selectedRole]).map(([permission, hasAccess]) => (
                                <label key={permission} className="flex items-center space-x-3 p-2 bg-gray-800 rounded-md">
                                    <input type="checkbox" checked={hasAccess} onChange={(e) => handlePermissionChange(selectedRole, permission, e.target.checked)}
                                           className="h-4 w-4 rounded bg-gray-700 border-gray-600 text-cyan-600 focus:ring-cyan-500" />
                                    <span>{permission}</span>
                                </label>
                            ))}
                        </div>
                    </main>
                </div>
            )}
        </Card>
    );
};

const AiConfig = () => {
    // State for Disease Detection
    const [sensitivity, setSensitivity] = React.useState(75);
    const [watchedDiseases, setWatchedDiseases] = React.useState({
        '白點病': true,
        '爛鰭病': true,
        '錨蟲病': false,
        '車輪蟲病': true,
    });

    // State for Bioeconomic DSS
    const [electricityCost, setElectricityCost] = React.useState(0.15);
    const [feedCost, setFeedCost] = React.useState(1.8);
    const [profitAlertThreshold, setProfitAlertThreshold] = React.useState(15);

    // State for Quality Grading
    const [uploadedFile, setUploadedFile] = React.useState(null);
    const [isTraining, setIsTraining] = React.useState(false);

    const handleDiseaseToggle = (disease) => {
        setWatchedDiseases(prev => ({ ...prev, [disease]: !prev[disease] }));
    };
    
    const handleFileChange = (e) => {
        if (e.target.files && e.target.files[0]) {
            setUploadedFile(e.target.files[0]);
        }
    };
    
    const handleRetrain = () => {
        if (!uploadedFile) {
            alert("請先上傳黃金標準影像檔。");
            return;
        }
        setIsTraining(true);
        setTimeout(() => {
            setIsTraining(false);
            alert("模型再訓練完成！");
            setUploadedFile(null);
        }, 3000); // Simulate training time
    };

    return (
        <div className="space-y-6">
            {/* 1. Fish Disease Detection Model */}
            <Card>
                <h3 className="text-lg font-semibold text-white mb-4 flex items-center"><Icon name="fa-shield-virus" className="mr-2 text-cyan-400"/>魚病偵測模型設定</h3>
                <div className="space-y-4">
                    <div>
                        <label htmlFor="sensitivity-slider" className="block text-sm font-medium text-gray-300 mb-2">警報靈敏度 (Sensitivity)</label>
                        <div className="flex items-center space-x-4">
                            <span className="text-xs text-gray-400">低</span>
                            <input id="sensitivity-slider" type="range" min="0" max="100" value={sensitivity} onChange={e => setSensitivity(Number(e.target.value))} className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" />
                            <span className="text-xs text-gray-400">高</span>
                            <span className="font-mono text-cyan-400 w-8 text-center">{sensitivity}</span>
                        </div>
                        <p className="text-xs text-gray-500 mt-1">靈敏度越高，越能偵測細微異常，但可能增加誤報。</p>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-300 mb-2">重點關注疾病</label>
                        <div className="grid grid-cols-2 gap-2">
                             {Object.entries(watchedDiseases).map(([disease, isWatched]) => (
                                <label key={disease} className="flex items-center space-x-2 bg-gray-700/50 p-2 rounded-md cursor-pointer hover:bg-gray-700">
                                    <input type="checkbox" checked={isWatched} onChange={() => handleDiseaseToggle(disease)} className="h-4 w-4 rounded bg-gray-800 border-gray-600 text-cyan-600 focus:ring-cyan-500"/>
                                    <span className="text-sm">{disease}</span>
                                </label>
                            ))}
                        </div>
                    </div>
                </div>
            </Card>

            {/* 2. Bioeconomic DSS Settings */}
            <Card>
                 <h3 className="text-lg font-semibold text-white mb-4 flex items-center"><Icon name="fa-dollar-sign" className="mr-2 text-green-400"/>生物經濟DSS設定</h3>
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label htmlFor="electricity-cost" className="block text-sm font-medium text-gray-300 mb-1">電力成本 ($/kWh)</label>
                        <div className="relative">
                            <input type="number" id="electricity-cost" value={electricityCost} onChange={e => setElectricityCost(Number(e.target.value))} step="0.01" className="w-full bg-gray-700 border-gray-600 rounded-md py-2 px-3 focus:ring-cyan-500 focus:border-cyan-500"/>
                        </div>
                    </div>
                     <div>
                        <label htmlFor="feed-cost" className="block text-sm font-medium text-gray-300 mb-1">主要飼料成本 ($/kg)</label>
                        <div className="relative">
                           <input type="number" id="feed-cost" value={feedCost} onChange={e => setFeedCost(Number(e.target.value))} step="0.1" className="w-full bg-gray-700 border-gray-600 rounded-md py-2 px-3 focus:ring-cyan-500 focus:border-cyan-500"/>
                        </div>
                    </div>
                    <div className="md:col-span-2">
                        <label htmlFor="profit-alert" className="block text-sm font-medium text-gray-300 mb-1">財務警報閾值</label>
                         <div className="relative">
                             <input type="number" id="profit-alert" value={profitAlertThreshold} onChange={e => setProfitAlertThreshold(Number(e.target.value))} className="w-full bg-gray-700 border-gray-600 rounded-md py-2 pl-3 pr-8 focus:ring-cyan-500 focus:border-cyan-500"/>
                              <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span className="text-gray-400 text-sm">%</span>
                            </div>
                        </div>
                         <p className="text-xs text-gray-500 mt-1">當預估利潤率低於此數值時，發出黃色警報。</p>
                    </div>
                 </div>
            </Card>

            {/* 3. Quality Grading Model */}
            <Card>
                <h3 className="text-lg font-semibold text-white mb-4 flex items-center"><Icon name="fa-award" className="mr-2 text-yellow-400"/>品質分級模型設定</h3>
                 <div>
                    <label className="block text-sm font-medium text-gray-300 mb-2">模型再訓練 (Retraining)</label>
                     <div className="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-600 border-dashed rounded-md">
                        <div className="space-y-1 text-center">
                             <Icon name="fa-images" className="mx-auto h-12 w-12 text-gray-500"/>
                            <div className="flex text-sm text-gray-400 justify-center">
                                <label htmlFor="file-upload" className="relative cursor-pointer bg-gray-800 rounded-md font-medium text-cyan-400 hover:text-cyan-300 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-offset-gray-900 focus-within:ring-cyan-500 px-1">
                                    <span>上傳一批影像</span>
                                    <input id="file-upload" name="file-upload" type="file" className="sr-only" onChange={handleFileChange} accept="image/*,.zip,.rar" multiple />
                                </label>
                                <p className="pl-1">或拖曳檔案到此處</p>
                            </div>
                            <p className="text-xs text-gray-500">上傳由專家分級的「黃金標準」影像 (.zip, .rar)</p>
                            {uploadedFile && <p className="text-sm text-green-400 pt-2">已選擇檔案: {uploadedFile.name}</p>}
                        </div>
                    </div>
                 </div>
                 <div className="mt-4">
                     <button onClick={handleRetrain} disabled={!uploadedFile || isTraining} className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-violet-600 hover:bg-violet-700 disabled:bg-gray-600 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-violet-500">
                         {isTraining ? (
                            <>
                                <Icon name="fa-spinner" className="animate-spin -ml-1 mr-3 h-5 w-5"/>
                                <span>訓練中...</span>
                            </>
                         ) : (
                            <>
                                <Icon name="fa-brain" className="mr-2"/>
                                <span>啟動模型再訓練</span>
                            </>
                         )}
                     </button>
                 </div>
            </Card>
        </div>
    );
};

const AutomationRules = () => {
    const [rules, setRules] = React.useState(initialAutomationRules);
    const [isEditing, setIsEditing] = React.useState(false);

    const handleToggleRule = (id) => {
        setRules(rules.map(rule => rule.id === id ? { ...rule, enabled: !rule.enabled } : rule));
    };

    const RuleEditor = () => (
        <div className="bg-gray-700/50 p-4 rounded-lg mb-4 space-y-4">
            <h4 className="text-md font-semibold text-white">新增/編輯規則</h4>
            <div>
                <label className="block text-xs font-medium text-gray-300 mb-1">規則名稱</label>
                <input type="text" placeholder="例如：低溶氧自動增氧" className="w-full bg-gray-800 border-gray-600 rounded-md py-2 px-3 text-sm focus:ring-cyan-500 focus:border-cyan-500"/>
            </div>
            <div className="border border-gray-600 p-3 rounded-md">
                 <h5 className="font-bold text-cyan-400 mb-2">IF (如果)</h5>
                 <div className="flex items-center gap-2 text-sm">
                    <span>當</span>
                    <select className="bg-gray-800 border-gray-600 rounded-md p-1 focus:ring-cyan-500 focus:border-cyan-500"><option>3號槽</option><option>所有槽</option></select>
                    <span>的</span>
                    <select className="bg-gray-800 border-gray-600 rounded-md p-1 focus:ring-cyan-500 focus:border-cyan-500"><option>溶氧量</option><option>溫度</option></select>
                    <select className="bg-gray-800 border-gray-600 rounded-md p-1 focus:ring-cyan-500 focus:border-cyan-500"><option>低於</option><option>高於</option></select>
                    <input type="number" defaultValue="5.0" className="w-16 bg-gray-800 border-gray-600 rounded-md p-1 focus:ring-cyan-500 focus:border-cyan-500"/>
                 </div>
            </div>
             <div className="border border-gray-600 p-3 rounded-md">
                 <h5 className="font-bold text-green-400 mb-2">THEN (則)</h5>
                 <div className="flex items-center gap-2 text-sm mb-2">
                    <select className="bg-gray-800 border-gray-600 rounded-md p-1 focus:ring-cyan-500 focus:border-cyan-500"><option>啟動</option><option>關閉</option></select>
                    <select className="bg-gray-800 border-gray-600 rounded-md p-1 focus:ring-cyan-500 focus:border-cyan-500"><option>3號槽增氧機</option></select>
                 </div>
                 <div className="flex items-center gap-2 text-sm">
                    <span>並且</span>
                    <select className="bg-gray-800 border-gray-600 rounded-md p-1 focus:ring-cyan-500 focus:border-cyan-500"><option>發送SMS通知</option><option>發送Email通知</option></select>
                    <span>給</span>
                     <select className="bg-gray-800 border-gray-600 rounded-md p-1 focus:ring-cyan-500 focus:border-cyan-500"><option>現場技術員群組</option></select>
                 </div>
            </div>
            <div className="flex justify-end gap-2">
                <button onClick={() => setIsEditing(false)} className="bg-gray-600 hover:bg-gray-500 px-3 py-1.5 rounded-md text-sm font-semibold">取消</button>
                <button onClick={() => setIsEditing(false)} className="bg-green-600 hover:bg-green-700 px-3 py-1.5 rounded-md text-sm font-semibold">儲存規則</button>
            </div>
        </div>
    );

    return (
        <Card>
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-semibold text-white">自動化規則與工作流程引擎</h3>
                <button onClick={() => setIsEditing(!isEditing)} className="bg-cyan-600 hover:bg-cyan-700 px-3 py-1.5 rounded-md text-sm font-semibold flex items-center">
                    <Icon name={isEditing ? "fa-times" : "fa-plus"} className="mr-2"/>{isEditing ? "取消" : "新增規則"}
                </button>
            </div>
            {isEditing && <RuleEditor />}
            <div className="space-y-3">
                {rules.map(rule => (
                    <div key={rule.id} className="bg-gray-900/50 p-3 rounded-lg flex justify-between items-center">
                        <div>
                            <p className="font-semibold text-white">{rule.name}</p>
                            <p className="text-xs text-gray-400">{rule.description}</p>
                        </div>
                        <ToggleSwitch enabled={rule.enabled} onChange={() => handleToggleRule(rule.id)} />
                    </div>
                ))}
            </div>
        </Card>
    );
};

const DataSettings = () => {
    const [apiKey, setApiKey] = React.useState('aqua_sk_****************************1234');
    const [showKey, setShowKey] = React.useState(false);

    return (
        <div className="space-y-6">
            <Card>
                <h3 className="text-lg font-semibold text-white mb-4"><Icon name="fa-database" className="mr-2 text-cyan-400"/>數據保留策略</h3>
                <div className="space-y-4">
                    <div className="flex items-center justify-between">
                        <label className="text-sm font-medium text-gray-300">水質數據</label>
                        <select className="w-1/3 bg-gray-700 border-gray-600 rounded-md py-1 px-2 text-sm focus:ring-cyan-500 focus:border-cyan-500">
                             <option>保留 5 年</option><option>保留 3 年</option><option>保留 1 年</option><option>永久保留</option>
                        </select>
                    </div>
                    <div className="flex items-center justify-between">
                        <label className="text-sm font-medium text-gray-300">影像數據</label>
                        <select className="w-1/3 bg-gray-700 border-gray-600 rounded-md py-1 px-2 text-sm focus:ring-cyan-500 focus:border-cyan-500">
                             <option>保留 1 年</option><option>保留 90 天</option><option>保留 30 天</option>
                        </select>
                    </div>
                </div>
            </Card>
            <Card>
                <h3 className="text-lg font-semibold text-white mb-4"><Icon name="fa-calendar-days" className="mr-2 text-yellow-400"/>自動報告排程</h3>
                 <div className="space-y-3">
                    <div className="bg-gray-700/50 p-2 rounded-md flex justify-between items-center text-sm">
                        <span>每週生產效益總結報告</span>
                        <span className="text-gray-400">每週一 08:00</span>
                    </div>
                 </div>
                 <button className="w-full mt-4 bg-gray-700 hover:bg-gray-600 text-sm py-2 rounded-md font-semibold">排程新報告</button>
            </Card>
            <Card>
                 <h3 className="text-lg font-semibold text-white mb-4"><Icon name="fa-key" className="mr-2 text-violet-400"/>API 與整合</h3>
                 <div className="space-y-2">
                     <p className="text-sm text-gray-400">使用此金鑰將 AquaNemo AI 數據與外部系統整合。</p>
                     <div className="flex items-center gap-2 bg-gray-900/50 p-2 rounded-md">
                        <input type="text" readOnly value={showKey ? apiKey.replace(/[*]/g, (c,i) => "ABCDEF1234567890"[i % 16]) : apiKey} className="w-full bg-transparent font-mono text-sm"/>
                        <button onClick={() => setShowKey(!showKey)}><Icon name={showKey ? 'fa-eye-slash' : 'fa-eye'} /></button>
                     </div>
                     <button className="text-sm text-cyan-400 hover:underline">重新生成金鑰</button>
                 </div>
            </Card>
        </div>
    );
};

const SystemHealth = () => {
    const logColors = { 'INFO': 'text-gray-400', 'WARN': 'text-yellow-400', 'ERROR': 'text-red-400' };

    return (
        <div className="space-y-6">
            <Card>
                 <h3 className="text-lg font-semibold text-white mb-4"><Icon name="fa-server" className="mr-2 text-cyan-400"/>硬體狀態</h3>
                 <div className="grid grid-cols-2 gap-3 max-h-48 overflow-y-auto pr-2">
                    {iotDeviceStatus.map(d => (
                        <div key={d.id} className="flex items-center space-x-2 bg-gray-700/50 p-2 rounded-md text-sm">
                             <span className={`w-2.5 h-2.5 rounded-full ${d.status === 'online' ? 'bg-green-500' : 'bg-red-500'}`}></span>
                             <span>{d.name}</span>
                             <span className="text-xs text-gray-500">(槽 {d.tankId})</span>
                        </div>
                    ))}
                 </div>
            </Card>
            <Card>
                 <h3 className="text-lg font-semibold text-white mb-4"><Icon name="fa-microchip" className="mr-2 text-yellow-400"/>系統資源使用率</h3>
                 <div className="space-y-3">
                     <div>
                        <div className="flex justify-between text-sm mb-1"><span>伺服器負載</span><span>35%</span></div>
                        <div className="w-full bg-gray-700 rounded-full h-2.5"><div className="bg-green-500 h-2.5 rounded-full" style={{width: '35%'}}></div></div>
                     </div>
                      <div>
                        <div className="flex justify-between text-sm mb-1"><span>記憶體用量</span><span>60%</span></div>
                        <div className="w-full bg-gray-700 rounded-full h-2.5"><div className="bg-yellow-500 h-2.5 rounded-full" style={{width: '60%'}}></div></div>
                     </div>
                      <div>
                        <div className="flex justify-between text-sm mb-1"><span>資料庫容量</span><span>82%</span></div>
                        <div className="w-full bg-gray-700 rounded-full h-2.5"><div className="bg-red-500 h-2.5 rounded-full" style={{width: '82%'}}></div></div>
                     </div>
                 </div>
            </Card>
            <Card>
                 <h3 className="text-lg font-semibold text-white mb-4"><Icon name="fa-file-lines" className="mr-2 text-violet-400"/>系統操作日誌</h3>
                 <div className="bg-gray-900/50 p-2 rounded-md font-mono text-xs h-48 overflow-y-auto">
                    {systemLogs.map((log, i) => (
                        <p key={i}><span className="text-gray-500">{log.timestamp} </span><span className={logColors[log.level]}>[{log.level}]</span> {log.message}</p>
                    ))}
                 </div>
            </Card>
        </div>
    );
};


const Settings = ({ onBack }) => {
    const [page, setPage] = React.useState('users');
    const NavLink = ({pageName, icon, text}) => (
        <a href="#" onClick={(e) => { e.preventDefault(); setPage(pageName); }} 
           className={`flex items-center space-x-3 p-3 rounded-md transition-colors text-sm font-medium ${page === pageName ? 'bg-cyan-500/20 text-cyan-400' : 'text-gray-300 hover:bg-gray-700'}`}>
            <Icon name={icon} className="w-5 text-center"/><span>{text}</span>
        </a>
    );

    return (
        <div className="p-6">
            <button onClick={onBack} className="mb-4 flex items-center space-x-2 text-cyan-400 hover:text-cyan-300">
                <Icon name="fa-arrow-left" />
                <span>返回儀表板</span>
            </button>
            <h2 className="text-2xl font-bold text-white mb-4">系統設定與管理</h2>
            <div className="flex flex-col lg:flex-row gap-6">
                <aside className="lg:w-1/4">
                    <Card className="p-2">
                        <nav className="space-y-1">
                           <NavLink pageName="users" icon="fa-users" text="使用者與權限管理" />
                           <NavLink pageName="farm" icon="fa-map-location-dot" text="養殖場域數位化建置" />
                           <NavLink pageName="ai" icon="fa-robot" text="AI 模組參數設定" />
                           <NavLink pageName="automation" icon="fa-gears" text="自動化規則與工作流程" />
                           <NavLink pageName="data" icon="fa-database" text="數據與報告設定" />
                           <NavLink pageName="health" icon="fa-heart-pulse" text="系統健康與維護" />
                        </nav>
                    </Card>
                </aside>
                <main className="lg:w-3/4">
                    {page === 'users' && <UserManagement />}
                    {page === 'farm' && <FarmSetup />}
                    {page === 'ai' && <AiConfig />}
                    {page === 'automation' && <AutomationRules />}
                    {page === 'data' && <DataSettings />}
                    {page === 'health' && <SystemHealth />}
                </main>
            </div>
        </div>
    );
};

const FinancialReports = ({ onBack }) => {
    const [period, setPeriod] = React.useState('30d');
    const profitMargin = financialSummary.revenue > 0 ? (financialSummary.profit / financialSummary.revenue * 100).toFixed(1) : 0;

    return (
        <div className="p-6">
            <button onClick={onBack} className="mb-4 flex items-center space-x-2 text-cyan-400 hover:text-cyan-300">
                <Icon name="fa-arrow-left" />
                <span>返回儀表板</span>
            </button>
            <div className="flex justify-between items-center mb-4">
                 <h2 className="text-2xl font-bold text-white">財務報表 (Financial Reports)</h2>
                 <div className="flex space-x-2">
                    <button onClick={() => setPeriod('30d')} className={`px-3 py-1 text-sm rounded-md ${period === '30d' ? 'bg-cyan-600 text-white' : 'bg-gray-700 hover:bg-gray-600'}`}>近30天</button>
                    <button onClick={() => setPeriod('90d')} className={`px-3 py-1 text-sm rounded-md ${period === '90d' ? 'bg-cyan-600 text-white' : 'bg-gray-700 hover:bg-gray-600'}`}>近90天</button>
                    <button onClick={() => setPeriod('ytd')} className={`px-3 py-1 text-sm rounded-md ${period === 'ytd' ? 'bg-cyan-600 text-white' : 'bg-gray-700 hover:bg-gray-600'}`}>年初至今</button>
                 </div>
            </div>

            {/* KPIs */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                 <Card className="text-center"><p className="text-sm text-gray-400">總收入</p><p className="text-3xl font-bold text-green-400">${financialSummary.revenue.toLocaleString()}</p></Card>
                 <Card className="text-center"><p className="text-sm text-gray-400">總成本</p><p className="text-3xl font-bold text-red-400">${financialSummary.costs.toLocaleString()}</p></Card>
                 <Card className="text-center"><p className="text-sm text-gray-400">淨利潤</p><p className="text-3xl font-bold text-white">${financialSummary.profit.toLocaleString()}</p></Card>
                 <Card className="text-center"><p className="text-sm text-gray-400">利潤率</p><p className="text-3xl font-bold text-white">{profitMargin}%</p></Card>
            </div>
            
            {/* Charts */}
            <div className="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-6">
                <Card className="lg:col-span-3">
                    <h3 className="font-bold mb-4">收入 vs 成本趨勢</h3>
                     <div className="h-64 bg-gray-900/50 p-4 rounded-md flex justify-around items-end">
                        {monthlyPerformance.map(m => (
                            <div key={m.month} className="flex flex-col items-center w-1/5">
                                <div className="flex items-end h-full w-full justify-center gap-2">
                                    <div className="w-1/3 bg-green-500 rounded-t-sm" style={{ height: `${(m.revenue / 60000) * 100}%`}} title={`收入: $${m.revenue}`}></div>
                                    <div className="w-1/3 bg-red-500 rounded-t-sm" style={{ height: `${(m.cost / 60000) * 100}%`}} title={`成本: $${m.cost}`}></div>
                                </div>
                                <p className="text-xs mt-2">{m.month}</p>
                            </div>
                        ))}
                    </div>
                </Card>
                <Card className="lg:col-span-2">
                    <h3 className="font-bold mb-4">成本結構</h3>
                     <div className="h-64 bg-gray-900/50 p-4 rounded-md flex items-center justify-center">
                         <div className="space-y-2 w-full">
                            {costBreakdown.map(c => {
                                const percentage = (c.value / financialSummary.costs * 100).toFixed(1);
                                return (
                                <div key={c.name}>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span>{c.name}</span>
                                        <span>{percentage}%</span>
                                    </div>
                                    <div className="w-full bg-gray-700 rounded-full h-2.5">
                                        <div className={`${c.color} h-2.5 rounded-full`} style={{width: `${percentage}%`}}></div>
                                    </div>
                                </div>
                                );
                            })}
                         </div>
                    </div>
                </Card>
            </div>
            
            {/* Batch Profitability Table */}
            <Card>
                <h3 className="font-bold mb-4">批次盈利能力</h3>
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left">
                        <thead className="text-xs text-gray-400 uppercase bg-gray-700/50">
                            <tr>
                                <th scope="col" className="px-6 py-3">批次ID</th>
                                <th scope="col" className="px-6 py-3">物種</th>
                                <th scope="col" className="px-6 py-3 text-right">收入</th>
                                <th scope="col" className="px-6 py-3 text-right">成本</th>
                                <th scope="col" className="px-6 py-3 text-right">利潤</th>
                            </tr>
                        </thead>
                        <tbody>
                            {batchProfitability.map(b => (
                                <tr key={b.id} className="border-b border-gray-700 hover:bg-gray-700/50">
                                    <td className="px-6 py-4 font-medium whitespace-nowrap">{b.id}</td>
                                    <td className="px-6 py-4">{b.species}</td>
                                    <td className="px-6 py-4 text-right text-green-400">${b.revenue.toLocaleString()}</td>
                                    <td className="px-6 py-4 text-right text-red-400">${b.cost.toLocaleString()}</td>
                                    <td className="px-6 py-4 text-right font-bold">${b.profit.toLocaleString()}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </Card>
        </div>
    );
};

const FishCard = ({ fish, onDragStart }) => (
    <div draggable onDragStart={(e) => onDragStart(e, fish)} className="bg-gray-800 border border-gray-700 rounded-lg overflow-hidden cursor-grab active:cursor-grabbing transform hover:-translate-y-1 transition-transform">
        <img src={fish.imageUrl} alt={fish.id} className="w-full h-40 object-cover" />
        <div className="p-3">
            <div className="flex justify-between items-start">
                <div>
                    <h4 className="font-bold text-lg text-white">{fish.id}</h4>
                    <p className="text-sm text-gray-400">{fish.species}</p>
                </div>
                <span className={`px-2 py-1 text-xs font-bold rounded-full ${fish.grade.startsWith('S') ? 'bg-yellow-500 text-gray-900' : 'bg-cyan-500 text-white'}`}>{fish.grade}</span>
            </div>
            <div className="mt-3 text-xs space-y-1 text-gray-300">
                {Object.entries(fish.traits).map(([key, value]) => (
                    <div key={key} className="flex justify-between"><span>{key}:</span><span className="font-mono">{value}</span></div>
                ))}
                <div className="flex justify-between"><span>親代:</span><span>{fish.parentId || 'N/A'}</span></div>
            </div>
        </div>
    </div>
);

const BreedingAssetHub = ({ onBack }) => {
    const [pair, setPair] = React.useState([null, null]);

    const handleDragStart = (e, fish) => {
        e.dataTransfer.setData("application/json", JSON.stringify(fish));
    };

    const handleDrop = (e, slot) => {
        e.preventDefault();
        const fishData = e.dataTransfer.getData("application/json");
        if(fishData) {
            const newFish = JSON.parse(fishData);
            const newPair = [...pair];
            newPair[slot] = newFish;
            setPair(newPair);
        }
        e.currentTarget.classList.remove('border-cyan-500');
    };

    const handleDragOver = (e) => {
        e.preventDefault();
        e.currentTarget.classList.add('border-cyan-500');
    };
    
    const handleDragLeave = (e) => {
        e.currentTarget.classList.remove('border-cyan-500');
    }

    return (
        <div className="p-6">
            <button onClick={onBack} className="mb-4 flex items-center space-x-2 text-cyan-400 hover:text-cyan-300">
                <Icon name="fa-arrow-left" />
                <span>返回儀表板</span>
            </button>
            <h2 className="text-2xl font-bold text-white mb-4">育種資產庫 (Breeding Asset Hub)</h2>
            <div className="flex flex-col lg:flex-row gap-6">
                {/* Main content */}
                <div className="flex-grow">
                    <Card>
                        <div className="flex flex-col md:flex-row gap-4 mb-4">
                            <div className="relative flex-grow">
                                <Icon name="fa-search" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                                <input type="text" placeholder="搜尋所有親代為#X10、白紋連接性評分高於4..." className="w-full bg-gray-700 border-gray-600 rounded-md pl-10 pr-4 py-2 focus:ring-cyan-500 focus:border-cyan-500"/>
                            </div>
                            <select className="bg-gray-700 border-gray-600 rounded-md px-4 py-2 focus:ring-cyan-500 focus:border-cyan-500">
                                <option>按等級排序</option>
                                <option>按ID排序</option>
                            </select>
                            <button className="bg-cyan-600 hover:bg-cyan-700 px-4 py-2 rounded-md font-semibold">搜尋</button>
                        </div>
                         <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                            {breedingAssets.map(fish => <FishCard key={fish.id} fish={fish} onDragStart={handleDragStart} />)}
                        </div>
                    </Card>
                </div>
                {/* Side panel */}
                <aside className="lg:w-1/3 xl:w-1/4 flex-shrink-0">
                    <Card>
                        <h3 className="font-bold text-lg mb-4 text-white"><Icon name="fa-basket-shopping" className="mr-2"/>配對籃 (Pairing Basket)</h3>
                        <p className="text-sm text-gray-400 mb-4">請從左側拖曳魚隻卡片到下方欄位進行配對。</p>
                        <div className="space-y-4">
                            {[0, 1].map(slot => (
                                <div key={slot} 
                                     onDrop={(e) => handleDrop(e, slot)} 
                                     onDragOver={handleDragOver}
                                     onDragLeave={handleDragLeave}
                                     className="h-24 border-2 border-dashed border-gray-600 rounded-lg flex items-center justify-center transition-colors">
                                    {pair[slot] ? (
                                        <div className="text-center">
                                            <p className="font-bold">{pair[slot]?.id}</p>
                                            <p className="text-xs text-gray-400">{pair[slot]?.species}</p>
                                        </div>
                                    ) : (
                                        <span className="text-gray-500">親代 {slot + 1}</span>
                                    )}
                                </div>
                            ))}
                        </div>
                        <button disabled={!pair[0] || !pair[1]} onClick={() => alert('啟動虛擬配對計算...')} className="w-full mt-4 bg-violet-600 hover:bg-violet-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-md transition-colors">
                           <Icon name="fa-calculator" className="mr-2"/> 啟動虛擬配對計算機
                        </button>
                    </Card>
                </aside>
            </div>
        </div>
    );
};

const SustainabilityReport = ({ onBack }) => {
    const [reportType, setReportType] = React.useState('asc');
    const [dateRange, setDateRange] = React.useState('30d');
    const [status, setStatus] = React.useState('idle');
    const [progress, setProgress] = React.useState(0);

    React.useEffect(() => {
        let timer;
        if (status === 'generating') {
            setProgress(0);
            const startTime = Date.now();
            timer = window.setInterval(() => {
                const elapsedTime = Date.now() - startTime;
                const progress = Math.min((elapsedTime / 3000) * 100, 100); // 3-second generation
                setProgress(progress);
                if (progress >= 100) {
                    clearInterval(timer);
                    setStatus('done');
                }
            }, 50);
        }
        return () => clearInterval(timer);
    }, [status]);
    
    const handleGenerate = () => {
        if(status !== 'generating') {
             setStatus('generating');
        }
    }
    
    const handleReset = () => {
        setStatus('idle');
        setProgress(0);
    }
    
    return (
        <div className="p-6">
             <button onClick={onBack} className="mb-4 flex items-center space-x-2 text-cyan-400 hover:text-cyan-300">
                <Icon name="fa-arrow-left" />
                <span>返回儀表板</span>
            </button>
            <h2 className="text-2xl font-bold text-white mb-4">報告與合規中心 (Reporting Center)</h2>
            <div className="max-w-3xl mx-auto">
                 <Card>
                    <div className="space-y-6">
                         <div>
                             <h3 className="text-lg font-semibold text-white mb-2">1. 選擇報告類型</h3>
                             <select value={reportType} onChange={(e) => setReportType(e.target.value)} disabled={status !== 'idle'} className="w-full bg-gray-700 border-gray-600 rounded-md py-2 px-3 focus:ring-cyan-500 focus:border-cyan-500 disabled:opacity-50">
                                 <option value="asc">ASC溫室氣體報告</option>
                                 <option value="fos">Friend of the Sea產銷履歷報告</option>
                                 <option value="gsi">GSI永續發展報告</option>
                             </select>
                         </div>
                          <div>
                             <h3 className="text-lg font-semibold text-white mb-2">2. 選擇時間範圍</h3>
                             <select value={dateRange} onChange={(e) => setDateRange(e.target.value)} disabled={status !== 'idle'} className="w-full bg-gray-700 border-gray-600 rounded-md py-2 px-3 focus:ring-cyan-500 focus:border-cyan-500 disabled:opacity-50">
                                 <option value="30d">近30天</option>
                                 <option value="90d">近90天</option>
                                 <option value="ytd">年初至今</option>
                             </select>
                         </div>
                         <div>
                            <h3 className="text-lg font-semibold text-white mb-2">3. 生成報告</h3>
                             <button onClick={handleGenerate} disabled={status !== 'idle'} className="w-full bg-cyan-600 hover:bg-cyan-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-md transition-colors flex items-center justify-center">
                                 <Icon name="fa-file-invoice" className="mr-2"/> 生成報告
                             </button>
                         </div>
                     </div>
                     
                     {(status === 'generating' || status === 'done') && (
                         <div className="mt-6 border-t border-gray-700 pt-6">
                            {status === 'generating' && (
                                <div>
                                    <p className="text-center text-lg font-semibold animate-pulse">正在為您生成報告...</p>
                                    <div className="w-full bg-gray-700 rounded-full h-2.5 my-4">
                                        <div className="bg-cyan-500 h-2.5 rounded-full" style={{width: `${progress}%`, transition: 'width 0.1s linear'}}></div>
                                    </div>
                                    <p className="text-center text-sm text-gray-400">正在從數據庫提取資料並進行合規性檢查...</p>
                                </div>
                            )}
                            {status === 'done' && (
                                <div className="text-center p-6 bg-gray-900/50 rounded-lg">
                                    <Icon name="fa-check-circle" className="text-5xl text-green-400 mb-4"/>
                                    <h4 className="text-xl font-bold text-white mb-2">報告已成功生成！</h4>
                                    <p className="text-gray-300 mb-6">您的「ASC溫室氣體報告 (近30天)」已準備就緒。</p>
                                    <div className="flex justify-center gap-4">
                                        <button onClick={handleReset} className="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded-md font-semibold">生成另一份報告</button>
                                        <button className="px-6 py-2 bg-green-600 hover:bg-green-700 rounded-md font-semibold flex items-center">
                                            <Icon name="fa-download" className="mr-2"/>下載報告 (PDF)
                                        </button>
                                    </div>
                                </div>
                            )}
                         </div>
                     )}
                 </Card>
            </div>
        </div>
    );
};


const App = () => {
    const [view, setView] = React.useState('dashboard');
    const [selectedTankId, setSelectedTankId] = React.useState(null);

    const handleSelectTank = (tankId) => {
        setSelectedTankId(tankId);
        setView('tank-details');
    };

    const handleBackToDashboard = () => {
        setSelectedTankId(null);
        setView('dashboard');
    }
    
    const renderView = () => {
        switch(view) {
            case 'tank-details':
                return <TankDetails tankId={selectedTankId} onBack={handleBackToDashboard} />;
            case 'decision-support':
                return <DecisionSupport onBack={handleBackToDashboard} />;
            case 'settings':
                return <Settings onBack={handleBackToDashboard} />;
            case 'financial-reports':
                return <FinancialReports onBack={handleBackToDashboard} />;
            case 'breeding-hub':
                return <BreedingAssetHub onBack={handleBackToDashboard} />;
            case 'sustainability-report':
                return <SustainabilityReport onBack={handleBackToDashboard} />;
            case 'dashboard':
            default:
                return <Dashboard onSelectTank={handleSelectTank} setView={setView} />;
        }
    }

    return (
        <div className="min-h-screen bg-gray-900 text-gray-100 font-sans">
            <Header setView={setView} />
            <main>
                {renderView()}
            </main>
        </div>
    );
};

const container = document.getElementById('root');
if (container) {
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
}
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>